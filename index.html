<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>SADRAZAM OS - MAIL MODULE</title>
<style>
/* SENÄ°N TASARIM â€” DEÄžÄ°ÅžMEDÄ° */
body{background:#030303;color:#e0e0e0;font-family:Consolas,monospace;display:flex;justify-content:center;align-items:center;height:100vh}
.tool-card{background:#0a0a0a;border:1px solid #1a1a1a;padding:30px;width:420px}
.btn{background:none;border:1px solid #00ffcc;color:#00ffcc;padding:12px;width:100%;margin-top:10px}
.mail-address{border:1px dashed #00ffcc;padding:10px;text-align:center;margin:15px 0}
.inbox{border:1px solid #1a1a1a;height:200px;overflow:auto;padding:10px}
.mail-item{border-bottom:1px solid #222;padding:6px;cursor:pointer}
</style>
</head>
<body>

<div class="tool-card">
  <h3>Temp Mail</h3>
  <div id="mailAddr" class="mail-address">BEKLEMEDE</div>
  <button class="btn" onclick="generateMail()">YENÄ° MAÄ°L</button>
  <div id="mailInbox" class="inbox">Inbox boÅŸ</div>
  <button class="btn" onclick="refreshInbox()">YENÄ°LE</button>
</div>

<script>
let currentToken = "";
let currentAddress = "";
let currentPassword = "";

// ðŸ”¥ SADECE GET + QUERY
async function callProxy(action, params = {}) {
  const q = new URLSearchParams({ action, ...params }).toString();
  const r = await fetch(`/api/proxy?${q}`);
  if (!r.ok) throw new Error("proxy error");
  return await r.json();
}

async function generateMail() {
  const addr = document.getElementById("mailAddr");
  const inbox = document.getElementById("mailInbox");

  addr.textContent = "OLUÅžTURULUYOR...";
  inbox.textContent = "Bekleniyor...";

  try {
    // 1ï¸âƒ£ Domain al
    const d = await callProxy("domains");
    const domain = d["hydra:member"][0].domain;

    // 2ï¸âƒ£ Rastgele mail
    const user = Math.random().toString(36).slice(2,10);
    currentPassword = "pw_" + Math.random().toString(36).slice(2,8);
    currentAddress = `${user}@${domain}`;

    // 3ï¸âƒ£ Hesap aÃ§
    await callProxy("create", {
      address: currentAddress,
      password: currentPassword
    });

    // 4ï¸âƒ£ Token
    const t = await callProxy("token", {
      address: currentAddress,
      password: currentPassword
    });

    currentToken = t.token;
    addr.textContent = currentAddress;
    inbox.textContent = "Mail bekleniyor...";

  } catch (e) {
    addr.textContent = "HATA";
    inbox.textContent = "Proxy / API hatasÄ±";
    console.error(e);
  }
}

async function refreshInbox() {
  if (!currentToken) return;

  const inbox = document.getElementById("mailInbox");
  inbox.textContent = "Kontrol ediliyor...";

  try {
    const d = await callProxy("messages", { token: currentToken });
    inbox.innerHTML = "";

    if (!d["hydra:member"].length) {
      inbox.textContent = "Yeni mail yok";
      return;
    }

    d["hydra:member"].forEach(m => {
      const div = document.createElement("div");
      div.className = "mail-item";
      div.textContent = m.subject || "(Konu yok)";
      div.onclick = async () => {
        const c = await callProxy("message", {
          token: currentToken,
          id: m.id
        });
        alert(c.text || "Ä°Ã§erik yok");
      };
      inbox.appendChild(div);
    });

  } catch (e) {
    inbox.textContent = "Inbox alÄ±namadÄ±";
  }
}
</script>

</body>
</html>

