<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SADRAZAM OS - MAIL MODULE</title>
    <style>
        :root {
            --bg: #030303;
            --accent: #00ffcc;
            --text: #e0e0e0;
            --border: #1a1a1a;
            --orange: #ff9f43;
            --red: #ff3e3e;
        }

        body { font-family: 'Consolas', monospace; background-color: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .tool-card { background: #0a0a0a; border: 1px solid var(--border); padding: 30px; border-radius: 8px; width: 100%; max-width: 500px; border-left: 4px solid var(--accent); }
        h2 { font-size: 1rem; color: var(--accent); text-transform: uppercase; letter-spacing: 2px; margin-top: 0; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        .mail-address { background: #000; padding: 15px; border: 1px dashed var(--accent); color: var(--accent); font-weight: bold; text-align: center; margin: 20px 0; word-break: break-all; font-size: 1.1rem; }
        .btn { background: transparent; border: 1px solid var(--accent); color: var(--accent); padding: 14px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.3s; text-transform: uppercase; margin-bottom: 10px; outline: none; }
        .btn:hover { background: var(--accent); color: #000; box-shadow: 0 0 15px rgba(0, 255, 204, 0.4); }
        .btn-secondary { border-color: var(--orange); color: var(--orange); }
        .btn-secondary:hover { background: var(--orange); color: #000; }
        .inbox { height: 250px; border: 1px solid var(--border); background: #000; margin-top: 15px; overflow-y: auto; padding: 10px; font-size: 0.9rem; }
        .mail-item { padding: 12px; border-bottom: 1px solid #1a1a1a; cursor: pointer; transition: 0.2s; }
        .mail-item:hover { background: #0d0d0d; color: var(--accent); }
        .warning-footer { margin-top: 25px; padding: 15px; border: 1px solid rgba(255, 62, 62, 0.3); background: rgba(255, 62, 62, 0.05); color: var(--red); font-size: 0.75rem; text-align: center; letter-spacing: 1px; }
    </style>
</head>
<body>

<div class="tool-card">
    <h2>Dinamik Mail Servisi (Vercel Proxy)</h2>

    <div id="mailAddr" class="mail-address">Sƒ∞STEM BEKLEMEDE...</div>
    <button class="btn" onclick="generateNewMail()">YENƒ∞ ANONƒ∞M ADRES √úRET</button>

    <div class="inbox" id="mailInbox">
        <div style="text-align:center;color:#444;padding:20px;">Gelen kutusu taranƒ±yor...</div>
    </div>

    <button class="btn btn-secondary" style="margin-top:15px;" onclick="refreshInbox()">GELEN KUTUSUNU G√úNCELLE</button>

    <div class="warning-footer">
        ‚ö† BU SERVƒ∞S GE√áƒ∞Cƒ∞Dƒ∞R. TARAYICI KAPANDIƒûINDA VERƒ∞LER Sƒ∞Lƒ∞Nƒ∞R.
    </div>
</div>

<script>
let currentToken = "";
let currentAddress = "";
let currentPassword = "";

// üî• proxy.js ile birebir uyumlu
async function callProxy(action, params = {}) {
    const q = new URLSearchParams({ action, ...params }).toString();
    const r = await fetch(`/api/proxy?${q}`);
    if (!r.ok) throw new Error("Proxy error");
    return await r.json();
}

async function generateNewMail() {
    const addr = document.getElementById("mailAddr");
    const inbox = document.getElementById("mailInbox");

    addr.textContent = "OLU≈ûTURULUYOR...";
    inbox.innerHTML = `<div style="text-align:center;color:var(--accent);padding:20px;">Baƒülantƒ± kuruluyor...</div>`;

    try {
        // 1Ô∏è‚É£ Domainler
        const domains = await callProxy("domains");
        const domain = domains["hydra:member"][0].domain;

        // 2Ô∏è‚É£ Rastgele hesap
        const user = Math.random().toString(36).slice(2, 10);
        currentPassword = "pw_" + Math.random().toString(36).slice(2);
        currentAddress = `${user}@${domain}`;

        // 3Ô∏è‚É£ Hesap a√ß
        await callProxy("create", {
            address: currentAddress,
            password: currentPassword
        });

        // 4Ô∏è‚É£ Token
        const tokenData = await callProxy("token", {
            address: currentAddress,
            password: currentPassword
        });

        currentToken = tokenData.token;
        addr.textContent = currentAddress;
        inbox.innerHTML = `<div style="text-align:center;color:#444;padding:20px;">Mail bekleniyor...</div>`;
    } catch (e) {
        addr.textContent = "HATA!";
        inbox.innerHTML = `<div style="text-align:center;color:var(--red);padding:20px;">Proxy / API hatasƒ±</div>`;
        console.error(e);
    }
}

async function refreshInbox() {
    if (!currentToken) return;

    const inbox = document.getElementById("mailInbox");
    inbox.innerHTML = `<div style="text-align:center;color:var(--orange);padding:20px;">Kontrol ediliyor...</div>`;

    try {
        const data = await callProxy("messages", { token: currentToken });
        const msgs = data["hydra:member"];

        if (!msgs.length) {
            inbox.innerHTML = `<div style="text-align:center;color:#444;padding:20px;">Yeni mesaj yok</div>`;
            return;
        }

        inbox.innerHTML = "";
        msgs.forEach(m => {
            const div = document.createElement("div");
            div.className = "mail-item";
            div.innerHTML = `<strong>${m.subject || "(Konu yok)"}</strong><br><small>${m.from.address}</small>`;
            div.onclick = async () => {
                const msg = await callProxy("message", {
                    token: currentToken,
                    id: m.id
                });
                alert(msg.text || "ƒ∞√ßerik yok");
            };
            inbox.appendChild(div);
        });
    } catch (e) {
        inbox.innerHTML = `<div style="text-align:center;color:var(--red);padding:20px;">Inbox alƒ±namadƒ±</div>`;
    }
}
</script>

</body>
</html>

